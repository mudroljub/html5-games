<!DOCTYPE HTML>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Skupština</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            cursor: crosshair;
        }

    </style>
</head>
<body>

    <canvas id="platno"></canvas>

    <script>

        // prilikom prvog ucitavanja prilagoditi sve slike

        // da ostaju na prozoru duze od brzine animacije
        // politicar menja sliku na pogodak
		// grafiti na skupstini vucicu pederu

        // problem: kad je presirok ekran, sece sliku po visini !

        "use strict";
        window.$ = function(selector) {
            return document.querySelector(selector);
        };


        /*************** VARIJABLE ***************/
		var nova_visina_pozadine;
		var pozicije_prozora;
        var misX;
        var misY;
        var animacija;
        var uvodna_spica;
        var politicar;
        var toma;
        var vulin;
        var karakteri = [];

        var BAZICNA_SIRINA_EKRANA = 1280;
        var BAZICNA_VISINA_SLIKE = 118;
        var BRZINA_IGRICE = 1500; // veci broj je sporije
        var vreme_igre = 30;
        var poeni = 0;
        var uvod = true;
        var igranje = false;

        var platno = document.getElementById('platno');
        platno.height = window.innerHeight;
        platno.width = window.innerWidth;

        var sadrzaj = platno.getContext('2d');
        sadrzaj.font = "30px Verdana";
        sadrzaj.fillStyle = "white";
        sadrzaj.strokeStyle = 'black';

        var pozadina = new Image();
        pozadina.onload = function() {
            nova_visina_pozadine = (window.innerWidth / pozadina.width) * pozadina.height;  // prilagodjava pozadinu
            sadrzaj.drawImage(pozadina, 0, 0, window.innerWidth, nova_visina_pozadine);
        };
        pozadina.src = 'slike/skupstina2.png';

        // nazivi su bitni, od njih pravi img objekte
        var slike = {
            vulin: 'slike/vulin-stari.png',
			toma: 'slike/toma.png',
            politicar: 'slike/politicar.png'
        }


        /*************** POZIVI ***************/

        ucitajSlike(slike, uvodniProzor);
        

        /*************** SLUSACI ***************/

		platno.addEventListener('click', reagujNaKlikove);


        /*************** FUNKCIJE ***************/



		function postaviScenu(){
            animacija = setInterval(azuriraj, BRZINA_IGRICE);
            praviKaraktere();   // zasivno od nova_visina_pozadine, koju kreira funkcija ucitajSlike()
            crtajSlike();
            prikaziPoene();
		}


		function azuriraj(){
            if(igranje){
                crtajSlike();
                prikaziPoene();
                vreme_igre--;
                proveriKraj();
            }
		}


        function ucitajSlike(slike, povratnaRadnja) {         // ucitava i pravi img objekte sa nazivima
            var brojSlika = Object.keys(slike).length;
            var ucitaneSlike = 0;

            for (var ova_slika in slike) {
                window[ova_slika + "_slika"] = new Image();              // pravi globalnu varijablu sa nazivom slike !
                window[ova_slika + "_slika"].onload = function kadUcitas() {
                    ucitaneSlike++;
                    if (ucitaneSlike >= brojSlika) {
                        povratnaRadnja();
                    }
                };
                window[ova_slika + "_slika"].src = slike[ova_slika];
                // 
                window[ova_slika + "_slika"].width = window[ova_slika + "_slika"].width / (window[ova_slika + "_slika"].height / BAZICNA_VISINA_SLIKE);
                window[ova_slika + "_slika"].height = BAZICNA_VISINA_SLIKE;
            }
        }


        function praviKaraktere(){
            for (var ovaj_lik in slike){
                window[ovaj_lik] = new Karakter(window[ovaj_lik + "_slika"]);
                karakteri.push(window[ovaj_lik]);
            }   // kraj for
        }   // kraj praviKaraktere()


        /* prvog crta gde bilo, za ostale proverava slobodno mesto */
        function crtajSlike(){
            sadrzaj.drawImage(pozadina, 0, 0, window.innerWidth, nova_visina_pozadine);

            vulin.slucajnaPozicija();
            vulin.crtaj();

            toma.slucajnaPozicija();
            toma.naSlobodnomCrtaj(karakteri);

            politicar.slucajnaPozicija();
            politicar.naSlobodnomCrtaj(karakteri);
        } // kraj crtajSlike


        function slucajniProzor(){
            var gornja_osa = nova_visina_pozadine/4;
            var donja_osa = nova_visina_pozadine/1.53;
            var slucajna_pozicija = Math.floor(Math.random() * 6);
            
            pozicije_prozora = [
                [window.innerWidth/5.9, gornja_osa],             // prvi prozor
                [window.innerWidth/2.2, gornja_osa],             // drugi prozor
                [window.innerWidth/1.35, gornja_osa],
                [window.innerWidth/5.9, donja_osa],
                [window.innerWidth/2.2, donja_osa],
                [window.innerWidth/1.35, donja_osa]
            ]
            return [pozicije_prozora[slucajna_pozicija][0], pozicije_prozora[slucajna_pozicija][1]];
        }


        function prikaziPoene(){
            sadrzaj.fillStyle="#000";
            sadrzaj.fillRect(20,80,180,100);
            sadrzaj.stroke();
            sadrzaj.fillStyle="#FFF";
            sadrzaj.font = "24px Verdana";
            sadrzaj.fillText("Poeni: " + poeni, 30, 120);
            sadrzaj.fillText("Vreme: " + vreme_igre, 30, 160);
        }


        function proveriPogodak(ovaj_lik, poruka, desno, dole){
            poruka = poruka || "Jaoj";
            desno = desno || (Math.random() * 100) - 50;
            dole = dole || (Math.random() * 100) - 50;

            sadrzaj.font = "30px Verdana";

            if( (misX > ovaj_lik.x && misX < ovaj_lik.x + ovaj_lik.sirina) && (misY > ovaj_lik.y && misY < ovaj_lik.y + ovaj_lik.visina) ){
                sadrzaj.fillText(poruka, misX+desno, misY+dole, 250);       // poslednji argument je maksimalna shirina
                sadrzaj.lineWidth = 1;
                sadrzaj.strokeText(poruka, misX+desno, misY+dole, 250);       // poslednji argument je maksimalna shirina
                poeni++;
            }
        }


        function uvodniProzor(){
            // pravi uvodnu animaciju
            var anim_x = -100;
            var anim_y = 200;

            uvodna_spica = setInterval(function(){
                sadrzaj.fillStyle = "black";
                sadrzaj.fillRect(0, 0, window.innerWidth, window.innerHeight);
                sadrzaj.fillStyle="#fff";
                sadrzaj.font = "48px Verdana";
                sadrzaj.fillText("Spremi se za obracun!", anim_x += 5, anim_y);
                if(anim_x > innerWidth-100) {
                    anim_x = -100;
                    anim_y += 100;
                }
                if(anim_y > innerHeight - 100) {
                    anim_y = 200;
                }

            }, 30);
        }


        function reagujNaKlikove(event){
            misX = event.clientX;
            misY = event.clientY;

            if(uvod){
                clearInterval(uvodna_spica);
                postaviScenu();
                igranje = true;
                uvod = false;
            }

            if(igranje){
                proveriPogodak(politicar);
				proveriPogodak(toma, "Evropa nema alternativu!");
                proveriPogodak(vulin, "To boli!")
                prikaziPoene();
            }
        }


        function proveriKraj(){
            if(vreme_igre < 1) {
                clearInterval(animacija);
                sadrzaj.fillRect(window.innerWidth/2 - window.innerWidth/4, window.innerHeight/2 - window.innerHeight/4, window.innerWidth/2, window.innerHeight/2);
                sadrzaj.fillStyle="#000";
                sadrzaj.font = "48px Verdana";
                sadrzaj.fillText("Igra je završena!", window.innerWidth/2 - window.innerWidth/4 + 100, window.innerHeight/2 - window.innerHeight/4 + 100);
                igranje = false;
            }
        }

        // prilagodjava sliku za razne ekrane, ne popravlja pogresnu velicinu slike!
        function prilagodiSliku(slika){
            var nova_sirina_slike = slika.width * (innerWidth/BAZICNA_SIRINA_EKRANA);
            var nova_visina_slike = slika.height * (innerWidth/BAZICNA_SIRINA_EKRANA);
            return [nova_sirina_slike, nova_visina_slike]
        }


        /*************** KLASE ***************/

        function Karakter(slika){
            this.x = slucajniProzor()[0];
            this.y = slucajniProzor()[1];
            this.sirina = slika.width;
            this.visina = slika.height;


            /* uzima slucajne koordinate i pripisuje sebi */
            this.slucajnaPozicija = function() {
                this.x = slucajniProzor()[0];
                this.y = slucajniProzor()[1];
            }   // slucajnaPozicija


            /* crta sebe na zadatim koordinatama ili slucajnim ako nisu zadate */
            this.crtaj = function(x, y) {
                if(!x) x = this.x;
                if(!y) y = this.y;
                sadrzaj.drawImage(slika, x, y, prilagodiSliku(slika)[0], prilagodiSliku(slika)[1]);
            }   // kraj crtaj


            /* proverava jel drugi karakter zauzeo njegovu poziciju */
            this.jelDrugiZauzeo = function(drugi_karakter){
                if(this.x == drugi_karakter.x && this.y == drugi_karakter.y){
                    return true;
                } else return false;
            }   // kraj jelDrugiZauzeo


            /* uzima niz likova, proverava dal su zauzeli njegovu poziciju, vraca jel slobodna */
            this.jelOvoSlobodno = function (ostali) {
                var index = ostali.indexOf(this);
                ostali.splice(index, 1);    // izbacuje sebe

                var slobodno = true;
                // ide redom kroz ostale i proverava sudar
                for (var i = 0; i < ostali.length; i++) {
                    slobodno = slobodno & !this.jelDrugiZauzeo(ostali[i]);
                }
                ostali.push(this);          // vraca sebe
                return slobodno;
            }   // kraj jelOvoSlobodno


            /* ako niko nije zauzeo poziciju, crta sebe, ako je zauzeto, uporno resetuje svoju poziciju */
            this.naSlobodnomCrtaj = function (drugi_karakter) {
                if ( this.jelOvoSlobodno(drugi_karakter) ) {
                    this.crtaj();
                } else {
                    while ( !this.jelOvoSlobodno(drugi_karakter) ) {
                        this.slucajnaPozicija();
                        if ( this.jelOvoSlobodno(drugi_karakter) ) {
                            this.crtaj();
                            break;
                        }
                    }
                }
            }   // kraj naSlobodnomCrtaj

        }   // kraj Karakter



    </script>
</body>

</html>