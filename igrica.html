<!DOCTYPE HTML>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Skupština</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            cursor: crosshair;
        }

    </style>
</head>
<body>

    <canvas id="platno"></canvas>

    <script>

        // da izlaze animirano, kao da proviruju
        // da ne izlaze uvek, nego da malo sacekaju
        // da ostaju na prozoru duze od brzine animacije
        // da menjaju sliku na pogodak
        // da nasumicno ispustaju parole
		// grafiti na skupstini vucicu pederu

        // problem: kad je presirok ekran, sece sliku po visini !

        "use strict";
        window.$ = function(selector) {
            return document.querySelector(selector);
        };


        /*************** VARIJABLE ***************/
		var nova_visina_pozadine;
		var pozicije_prozora;
        var misX;
        var misY;
        var ovaAnimacija;
        var uvodna_spica;
        var slova_x = -100;
        var slova_y = 200;

        var BAZICNA_SIRINA_EKRANA = 1280;
        var BAZICNA_VISINA_SLIKE = 118;
        var vreme_igre = 30;
        var poeni = 0;
        var uvod = true;
        var igranje = false;
        var referentna_sekunda = 0;
        var karakteri = [];

        var platno = document.getElementById('platno');
        platno.height = window.innerHeight;
        platno.width = window.innerWidth;

        var sadrzaj = platno.getContext('2d');
        sadrzaj.font = "30px Verdana";
        sadrzaj.fillStyle = "white";
        sadrzaj.strokeStyle = 'black';

        var pozadina = new Image();
        pozadina.onload = function() {
            nova_visina_pozadine = (window.innerWidth / pozadina.width) * pozadina.height;  // prilagodjava pozadinu
            sadrzaj.drawImage(pozadina, 0, 0, window.innerWidth, nova_visina_pozadine);
        };
        pozadina.src = 'slike/skupstina2.png';

        // nazivi su bitni, od njih pravi objekte i slike !
        var slike = {
            vulin: 'slike/vulin.png',
			toma: 'slike/toma.png',
            dacic: 'slike/dacic.png'
        }
        var brojSlika = Object.keys(slike).length;


        /*************** POZIVI ***************/

        praviSlike(slike, pustiUvod);
        

        /*************** SLUSACI ***************/

		platno.addEventListener('click', reagujNaKlik);


        /*************** FUNKCIJE ***************/

		function postaviScenu(){
            ovaAnimacija = requestAnimationFrame(azuriraj);

            praviKaraktere(slike);   // pravi karaktere od datih slika
            crtajSlike();
            prikaziPoene();
		}


		function azuriraj(){
            if(igranje){
                var ova_sekunda = new Date().getSeconds();
                if(referentna_sekunda != ova_sekunda) {
                    crtajSlike();
                    referentna_sekunda = ova_sekunda;
                    vreme_igre--;
                }
                prikaziPoene();
                proveriKraj();
                ovaAnimacija = requestAnimationFrame(azuriraj);
            }
		}


        function praviSlike(slike, povratnaRadnja) {                            // ucitava i pravi img objekte sa nazivima
            var ucitaneSlike = 0;
            for (var ova_slika in slike) {
                window[ova_slika + "_slika"] = new Image();                     // pravi globalnu varijablu sa nazivom slike !
                window[ova_slika + "_slika"].onload = function kadUcita() {
                    ucitaneSlike++;
                    if (ucitaneSlike >= brojSlika) {
                        prilagodiSlike(slike);
                        povratnaRadnja();
                    }
                };  // kraj kadUcita()
                window[ova_slika + "_slika"].src = slike[ova_slika];
            }
        }


        function prilagodiSlike(slike){
            for (var ova_slika in slike) {
                // prilagodjava sliku standardnoj velicini slike
                window[ova_slika + "_slika"].width = window[ova_slika + "_slika"].width / (window[ova_slika + "_slika"].height / BAZICNA_VISINA_SLIKE);
                window[ova_slika + "_slika"].height = BAZICNA_VISINA_SLIKE;
                // prilagodjava sliku za razne ekrane
                window[ova_slika + "_slika"].width = window[ova_slika + "_slika"].width * (window.innerWidth/BAZICNA_SIRINA_EKRANA);
                window[ova_slika + "_slika"].height = window[ova_slika + "_slika"].height * (window.innerWidth/BAZICNA_SIRINA_EKRANA);
            }
        }


        function praviKaraktere(slike){
            for (var ovaj_lik in slike){
                window[ovaj_lik] = new Karakter(window[ovaj_lik + "_slika"]);
                karakteri.push(window[ovaj_lik]);
            }   // kraj for
        }   // kraj praviKaraktere()


        function crtajSlike(){
            sadrzaj.drawImage(pozadina, 0, 0, window.innerWidth, nova_visina_pozadine);
            dacic.naSlobodnomCrtaj(karakteri);

            if(vreme_igre <= 20) {
                vulin.naSlobodnomCrtaj(karakteri);
            }
            if(vreme_igre <= 10) {
                toma.naSlobodnomCrtaj(karakteri);
            }
        } // kraj crtajSlike


        function slucajniProzor(){
            var gornja_osa = nova_visina_pozadine/4;
            var donja_osa = nova_visina_pozadine/1.53;
            var slucajna_pozicija = Math.floor(Math.random() * 6);
            pozicije_prozora = [
                [window.innerWidth/5.9, gornja_osa],             // prvi prozor
                [window.innerWidth/2.2, gornja_osa],             // drugi prozor
                [window.innerWidth/1.35, gornja_osa],
                [window.innerWidth/5.9, donja_osa],
                [window.innerWidth/2.2, donja_osa],
                [window.innerWidth/1.35, donja_osa]
            ]
            return [pozicije_prozora[slucajna_pozicija][0], pozicije_prozora[slucajna_pozicija][1]];
        }


        function prikaziPoene(){
            sadrzaj.fillStyle="#000";
            sadrzaj.fillRect(20,80,180,100);
            sadrzaj.stroke();
            sadrzaj.fillStyle="#FFF";
            sadrzaj.font = "24px Verdana";
            sadrzaj.fillText("Poeni: " + poeni, 30, 120);
            sadrzaj.fillText("Vreme: " + vreme_igre, 30, 160);
        }


        function proveriPogodak(ovaj_lik, poruka, desno, dole){
            poruka = poruka || "Jaoj";
            desno = desno || (Math.random() * 100) - 50;
            dole = dole || (Math.random() * 100) - 50;
            // upisuje poene i ostavlja poruku
            sadrzaj.font = "30px Verdana";
            if( (misX > ovaj_lik.x && misX < ovaj_lik.x + ovaj_lik.sirina) && (misY > ovaj_lik.y && misY < ovaj_lik.y + ovaj_lik.visina) ){
                sadrzaj.fillText(poruka, misX+desno, misY+dole, 250);           // poslednji argument je maksimalna shirina teksta
                sadrzaj.lineWidth = 1;
                sadrzaj.strokeText(poruka, misX+desno, misY+dole, 250);         // poslednji argument je maksimalna shirina teksta
                poeni++;
            }
        }


        function pustiUvod(){
            // pravi uvodnu animaciju
            //uvodna_spica = setInterval(iduSlova, 30);

            uvodna_spica = requestAnimationFrame(iduSlova);

        }


        function iduSlova(){
            sadrzaj.fillStyle = "black";
            sadrzaj.fillRect(0, 0, window.innerWidth, window.innerHeight);
            sadrzaj.fillStyle="#fff";
            sadrzaj.font = "48px Verdana";
            sadrzaj.fillText("Spremi se za obracun!", slova_x += 5, slova_y);
            if(slova_x > innerWidth-100) {
                slova_x = -100;
                slova_y += 100;
            }
            if(slova_y > innerHeight - 100) {
                slova_y = 200;
            }
            uvodna_spica = requestAnimationFrame(iduSlova);
        }


        function reagujNaKlik(event){
            misX = event.clientX;
            misY = event.clientY;

            if(uvod){
                cancelAnimationFrame(uvodna_spica);
                postaviScenu();
                igranje = true;
                uvod = false;
            }

            if(igranje){
                proveriPogodak(dacic);
				proveriPogodak(toma, "Evropa nema alternativu!");
                proveriPogodak(vulin, "To boli!");
                prikaziPoene();
            }
        }


        function proveriKraj(){
            if(vreme_igre < 1) {
                cancelAnimationFrame(ovaAnimacija);
                sadrzaj.fillRect(window.innerWidth/2 - window.innerWidth/4, window.innerHeight/2 - window.innerHeight/4, window.innerWidth/2, window.innerHeight/2);
                sadrzaj.fillStyle="#000";
                sadrzaj.font = "48px Verdana";
                sadrzaj.fillText("Igra je završena!", window.innerWidth/2 - window.innerWidth/4 + 100, window.innerHeight/2 - window.innerHeight/4 + 100);
                igranje = false;
            }
        }


        /*************** KLASE ***************/

        function Karakter(slika){
            // potrebno za proveru sudara
            this.sirina = slika.width;
            this.visina = slika.height;
            this.mrdanjeSlike;

            /* uzima slucajne koordinate i pripisuje sebi */
            this.slucajnaPozicija = function() {
                this.x = slucajniProzor()[0];
                this.y = slucajniProzor()[1];
            }   // slucajnaPozicija


            /* crta sebe na trenutnim ili zadatim koordinatama */
            this.crtaj = function(x, y) {                                       // opciono prima koordinate ili koristi svoje
                if(!x) x = this.x;
                if(!y) y = this.y;
                sadrzaj.drawImage(slika, x, y, slika.width, slika.height);      // ako ne ekspliciram crta naturalWidth i naturalHeight
            }   // kraj crtaj


            /* proverava jel drugi karakter zauzeo njegovu poziciju */
            this.jelDrugiZauzeo = function(drugi_karakter){
                if(this.x == drugi_karakter.x && this.y == drugi_karakter.y){
                    return true;
                } else return false;
            }   // kraj jelDrugiZauzeo


            /* prima niz likova, proverava dal su zauzeli njegovu poziciju, vraca jel slobodna */
            this.jelOvoSlobodno = function (ostali) {
                var index = ostali.indexOf(this);
                ostali.splice(index, 1);    // izbacuje sebe

                var slobodno = true;
                // ide redom kroz ostale i proverava sudar
                for (var i = 0; i < ostali.length; i++) {
                    slobodno = slobodno & !this.jelDrugiZauzeo(ostali[i]);
                }
                ostali.push(this);          // vraca sebe
                return slobodno;
            }   // kraj jelOvoSlobodno


            /* ako niko nije zauzeo poziciju, crta sebe, ako je zauzeto, uporno resetuje svoju poziciju */
            this.naSlobodnomCrtaj = function (ostali) {
                this.slucajnaPozicija();
                if ( this.jelOvoSlobodno(ostali) ) {
                    this.crtaj();
                } else {
                    while ( !this.jelOvoSlobodno(ostali) ) {
                        this.slucajnaPozicija();
                        if ( this.jelOvoSlobodno(ostali) ) {
                            this.crtaj();
                        }
                    }
                }
            }   // kraj naSlobodnomCrtaj

        }   // kraj Karakter



    </script>
</body>

</html>