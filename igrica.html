<!DOCTYPE HTML>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Skupština</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            cursor: crosshair;
        }

    </style>
</head>
<body>

    <canvas id="platno"></canvas>

    <script>

        // proverava sudar ovog sa svima redom
        // nakon sto dodeli pozicije, pre nego ih iscrta

        // da ostaju na prozoru duze od brzine animacije
        // politicar menja sliku na pogodak

        "use strict";
        window.$ = function(selector) {
            return document.querySelector(selector);
        };


        /*************** VARIJABLE ***************/
		var nova_visina_pozadine;
		var pozicije_prozora;
        var misX;
        var misY;
        var animacija;
        var uvodna_spica;
        var politicar;
        var politicar2;
        var vulin;
        var karakteri = [];

        var BAZICNA_SIRINA = 1280; // ekrana
        var BRZINA_IGRICE = 1500; // veci broj je sporije
        var vreme_igre = 30;
        var poeni = 0;
        var uvod = true;
        var igranje = false;

        var platno = document.getElementById('platno');
        platno.height = window.innerHeight;
        platno.width = window.innerWidth;

        var sadrzaj = platno.getContext('2d');
        sadrzaj.font = "30px Verdana";
        sadrzaj.fillStyle = "white";
        sadrzaj.strokeStyle = 'black';

        // nazivi su bitni, od njih pravi img objekte
        var slike = {
            pozadina: 'slike/skupstina.png',            // pozadina mora da se zove pozadina, ostalo kako bilo !
            vulin_slika: 'slike/vulin.png',
            politicar_slika: 'slike/politicar.png'
        }


        /*************** POZIVI ***************/

        ucitajSlike(slike, function(slike) {
            uvodniProzor();
        });
        

        /*************** SLUSACI ***************/

		platno.addEventListener('click', function(event){
            misX = event.clientX;
            misY = event.clientY;

            if(uvod){
                clearInterval(uvodna_spica);
                uvod = false;
                postaviScenu();
                igranje = true;
            }

            if(igranje){
                proveriPogodak(politicar);
                proveriPogodak(vulin, "To boli!")
                prikaziPoene();
            }
		})


        /*************** FUNKCIJE ***************/

		function postaviScenu(){
            animacija = setInterval(azuriraj, BRZINA_IGRICE);
            praviKaraktere();   // zasivno od nova_visina_pozadine, koju kreira funkcija ucitajSlike()
            crtajSlike();
            prikaziPoene();
		}


		function azuriraj(){
            if(igranje){

                crtajSlike();
                prikaziPoene();
                vreme_igre--;
                proveriKraj();
            }
		}


        function ucitajSlike(slike, povratnaRadnja) {         // ucitava i pravi img objekte sa nazivima
            var brojSlika = Object.keys(slike).length;
            var ucitaneSlike = 0;

            for (var ova_slika in slike) {
                // pravi globalnu varijablu sa nazivom slike !
                window[ova_slika] = new Image();

                // kada ucita ovu sliku, ako su ostale ucitane, poziva povratnu funkciju
                window[ova_slika].onload = function() {
                    ucitaneSlike++;
                    if (ucitaneSlike >= brojSlika) {
                        povratnaRadnja();
                    }
                };
                // daje izvor slici
                window[ova_slika].src = slike[ova_slika];
            }
            nova_visina_pozadine = (window.innerWidth / pozadina.width) * pozadina.height;  // prilagodjava pozadinu
        }


        function praviKaraktere(){
            politicar = new Karakter(politicar_slika);
            politicar2 = new Karakter(politicar_slika);
            vulin = new Karakter(vulin_slika);
            karakteri.push(politicar);
            karakteri.push(politicar2);
            karakteri.push(vulin);
        }


        function crtajSlike(){      // iznova crta slike svaki frejm
            sadrzaj.drawImage(pozadina, 0, 0, window.innerWidth, nova_visina_pozadine);

            // uzima koordinate
            vulin.slucajnaPozicija();
            vulin.crtaj();

            politicar.slucajnaPozicija();

            // proverava da li se na toj poziciji vec nalazi neko od ostalih
            // ako ne, crta
            // ako da, menja poziciju i ponovo proverava
            politicar.imaSudar(vulin);
            politicar.crtaj();


        } // kraj crtajSlike



        /*
        function akoJeSlobodnoCrtaj(ovaj, drugi){
            if(!ovaj.imaSudar(drugi)) {
                ovaj.crtaj();
            } else {
                while(ovaj.imaSudar(drugi)) {
                    ovaj.slucajnaPozicija();
                    if(!ovaj.imaSudar(drugi)) {
                        ovaj.crtaj();
                        break;
                    }
                } // kraj while
            } // kraj else
        }
*/

        // vraca true/false
        function proveriSudar(ovaj, ostali){
            // izbacuje sebe
            var index = ostali.indexOf(ovaj);
            if (index > -1) {
                console.log(ostali)
                ostali.splice(index, 1);
            }

            // ide redom kroz ostale i proverava sudar
            for (var i = 0; i < ostali.length; i++) {

                // crta sebe na prvo slobodno mesto
                if( !ovaj.imaSudar(ostali[i]) ) {
                    ovaj.crtaj();
                    break;
                }
            }
        }


        function dajKoordinate(){
            var slucajna_pozicija = Math.floor(Math.random() * 6);
            pozicije_prozora = [
                [window.innerWidth/5.9, nova_visina_pozadine/4],             // prvi prozor
                [window.innerWidth/2.2, nova_visina_pozadine/4],
                [window.innerWidth/1.35, nova_visina_pozadine/4],
                [window.innerWidth/5.9, nova_visina_pozadine/1.55],
                [window.innerWidth/2.2, nova_visina_pozadine/1.55],
                [window.innerWidth/1.35, nova_visina_pozadine/1.55]
            ]
            return [pozicije_prozora[slucajna_pozicija][0], pozicije_prozora[slucajna_pozicija][1]];
        }


        function prikaziPoene(){
            sadrzaj.fillStyle="#000";
            sadrzaj.fillRect(20,80,180,100);
            sadrzaj.stroke();
            sadrzaj.fillStyle="#FFF";
            sadrzaj.font = "24px Verdana";
            sadrzaj.fillText("Poeni: " + poeni, 30, 120);
            sadrzaj.fillText("Vreme: " + vreme_igre, 30, 160);
        }


        function proveriPogodak(ovaj_lik, poruka, desno, dole){
            poruka = poruka || "Jaoj";
            desno = desno || (Math.random() * 100) - 50;
            dole = dole || (Math.random() * 100) - 50;
            if( (misX > ovaj_lik.x && misX < ovaj_lik.x + ovaj_lik.sirina) && (misY > ovaj_lik.y && misY < ovaj_lik.y + ovaj_lik.visina) ){
                sadrzaj.fillText(poruka, misX + desno, misY + dole);
                poeni++;
            }
        }


        function uvodniProzor(){
            var anim_x = -100;
            var anim_y = 200;

            uvodna_spica = setInterval(function(){
                sadrzaj.fillStyle = "black";
                sadrzaj.fillRect(0, 0, window.innerWidth, window.innerHeight);
                sadrzaj.fillStyle="#fff";
                sadrzaj.font = "48px Verdana";
                sadrzaj.fillText("Spremi se za obracun!", anim_x += 5, anim_y);
                if(anim_x > innerWidth-100) {
                    anim_x = -100;
                    anim_y += 100;
                }
                if(anim_y > innerHeight - 100) {
                    anim_y = 200;
                }

            }, 30);
        }


        function proveriKraj(){
            if(vreme_igre < 1) {
                clearInterval(animacija);
                sadrzaj.fillRect(window.innerWidth/2 - window.innerWidth/4, window.innerHeight/2 - window.innerHeight/4, window.innerWidth/2, window.innerHeight/2);
                sadrzaj.fillStyle="#000";
                sadrzaj.font = "48px Verdana";
                sadrzaj.fillText("Igra je završena!", window.innerWidth/2 - window.innerWidth/4 + 100, window.innerHeight/2 - window.innerHeight/4 + 100);
                igranje = false;
            }
        }

        // prilagodjava sliku za razne ekrane, ne popravlja pogresnu velicinu slike!
        function prilagodiSliku(slika){
            var nova_sirina_slike = slika.width * (innerWidth/BAZICNA_SIRINA);
            var nova_visina_slike = slika.height * (innerWidth/BAZICNA_SIRINA);
            return [nova_sirina_slike, nova_visina_slike]
        }


        /*************** KLASE ***************/

        function Karakter(slika){
            this.x = dajKoordinate()[0];
            this.y = dajKoordinate()[1];
            this.sirina = slika.width;
            this.visina = slika.height;

            this.crtaj = function(x, y) {
                if(!x) x = this.x;
                if(!y) y = this.y;
                sadrzaj.drawImage(slika, x, y, prilagodiSliku(slika)[0], prilagodiSliku(slika)[1]);
            }

            this.slucajnaPozicija = function() {
                this.x = dajKoordinate()[0];
                this.y = dajKoordinate()[1];
            }
            this.imaSudar = function(drugi){
                if(this.x == drugi.x && this.y == drugi.y){
                    return true;
                } else return false;
            }

        }


    </script>
</body>

</html>